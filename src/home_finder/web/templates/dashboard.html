{% extends "base.html" %}

{% block title %}Home Finder â€” Dashboard{% endblock %}

{% block nav_info %}<span id="nav-count">{{ total }} properties{% if active_filters %} <small>({{ active_filters|length }} filter{{ 's' if active_filters|length != 1 }} active)</small>{% endif %}</span>{% endblock %}

{% block content %}
<div id="loading" class="htmx-indicator loading-fixed">
    <div class="loading-bar"></div>
</div>

<section class="filter-bar">
    <form class="filter-form" method="GET" action="/"
          hx-get="/" hx-target="#results" hx-push-url="true" hx-indicator="#loading">
        <div class="filter-row">
            <div class="filter-controls" role="group">
                <select name="bedrooms" aria-label="Bedrooms">
                    <option value="">All beds</option>
                    <option value="0" {% if bedrooms == 0 %}selected{% endif %}>Studio</option>
                    {% for b in [1, 2, 3, 4] %}
                    <option value="{{ b }}" {% if bedrooms == b %}selected{% endif %}>{{ b }} bed</option>
                    {% endfor %}
                </select>

                <input type="number" name="min_price" placeholder="Min price" value="{{ min_price or '' }}" aria-label="Min price" step="50">
                <input type="number" name="max_price" placeholder="Max price" value="{{ max_price or '' }}" aria-label="Max price" step="50">

                <select name="area" aria-label="Area">
                    <option value="">All areas</option>
                    {% for a in search_areas %}
                    <option value="{{ a }}" {% if area and area|upper == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>

                <select name="min_rating" aria-label="Min rating">
                    <option value="">Any rating</option>
                    {% for r in [3, 4, 5] %}
                    <option value="{{ r }}" {% if min_rating == r %}selected{% endif %}>{{ r }}+ stars</option>
                    {% endfor %}
                </select>

                <select name="sort" aria-label="Sort">
                    <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
                    <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price: Low</option>
                    <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price: High</option>
                    <option value="rating_desc" {% if sort == "rating_desc" %}selected{% endif %}>Rating</option>
                    <option value="fit_desc" {% if sort == "fit_desc" %}selected{% endif %}>Best Fit</option>
                </select>

                <button type="submit" class="secondary">Apply</button>
                {% if active_filters %}
                <a href="/" role="button" class="outline secondary filter-reset"
                   hx-get="/" hx-target="#results" hx-push-url="true" hx-indicator="#loading">Reset</a>
                {% endif %}
            </div>
        </div>
        <details class="quality-filters" {% if any_quality_filter_active %}open{% endif %}>
            <summary>More filters</summary>
            <div class="filter-controls">
                <select name="property_type" aria-label="Property type">
                    <option value="">Any type</option>
                    {% for t in ["victorian", "edwardian", "georgian", "new_build", "purpose_built", "warehouse", "ex_council", "period_conversion"] %}
                    <option value="{{ t }}" {% if property_type == t %}selected{% endif %}>{{ t | replace("_", " ") | title }}</option>
                    {% endfor %}
                </select>

                <select name="outdoor_space" aria-label="Outdoor space">
                    <option value="">Outdoor</option>
                    <option value="yes" {% if outdoor_space == "yes" %}selected{% endif %}>Has outdoor</option>
                    <option value="no" {% if outdoor_space == "no" %}selected{% endif %}>No outdoor</option>
                </select>

                <select name="natural_light" aria-label="Natural light">
                    <option value="">Any light</option>
                    {% for l in ["excellent", "good", "fair", "poor"] %}
                    <option value="{{ l }}" {% if natural_light == l %}selected{% endif %}>{{ l | title }} light</option>
                    {% endfor %}
                </select>

                <select name="pets" aria-label="Pets allowed">
                    <option value="">Pets</option>
                    <option value="yes" {% if pets == "yes" %}selected{% endif %}>Pets allowed</option>
                </select>

                <select name="value_rating" aria-label="Value rating">
                    <option value="">Any value</option>
                    {% for v in ["excellent", "good", "fair", "poor"] %}
                    <option value="{{ v }}" {% if value_rating == v %}selected{% endif %}>{{ v | title }} value</option>
                    {% endfor %}
                </select>

                <select name="hob_type" aria-label="Hob type">
                    <option value="">Any hob</option>
                    {% for h in ["gas", "induction", "electric"] %}
                    <option value="{{ h }}" {% if hob_type == h %}selected{% endif %}>{{ h | title }}</option>
                    {% endfor %}
                </select>

                <select name="floor_level" aria-label="Floor level">
                    <option value="">Any floor</option>
                    {% for f in ["basement", "ground", "lower", "upper", "top"] %}
                    <option value="{{ f }}" {% if floor_level == f %}selected{% endif %}>{{ f | title }}</option>
                    {% endfor %}
                </select>

                <select name="building_construction" aria-label="Construction">
                    <option value="">Any build</option>
                    {% for c in ["solid_brick", "concrete", "timber_frame", "mixed"] %}
                    <option value="{{ c }}" {% if building_construction == c %}selected{% endif %}>{{ c | replace("_", " ") | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </details>
        <div class="filter-toolbar">
            <div class="view-toggle">
                <button type="button" class="view-toggle-btn active" data-view="grid" aria-label="Grid view" aria-pressed="true">
                    <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
                    <span class="view-toggle-label">Grid</span>
                </button>
                <button type="button" class="view-toggle-btn" data-view="split" aria-label="Split view" aria-pressed="false">
                    <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="14" rx="1"/><rect x="9" y="1" width="6" height="14" rx="1"/></svg>
                    <span class="view-toggle-label">Split</span>
                </button>
                <button type="button" class="view-toggle-btn" data-view="map" aria-label="Map view" aria-pressed="false">
                    <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1C5.2 1 3 3.2 3 6c0 3.5 5 9 5 9s5-5.5 5-9c0-2.8-2.2-5-5-5zm0 7a2 2 0 110-4 2 2 0 010 4z"/></svg>
                    <span class="view-toggle-label">Map</span>
                </button>
            </div>
        </div>
    </form>
</section>

<script>var propertiesMapData = {{ properties_json | safe }};</script>

<div id="split-container" class="split-container">
    <div id="results">
        {% include "_results.html" %}
    </div>
    <div id="dashboard-map" hidden></div>
</div>
{% endblock %}
