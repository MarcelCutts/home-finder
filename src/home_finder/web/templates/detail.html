{% extends "base.html" %}
{% from "_macros.html" import commute_pill, fit_badge, fit_tier_label, fit_tier_class %}

{% block title %}{{ prop.title }} — Home Finder{% endblock %}

{% block nav_info %}<a href="/">&larr; Dashboard</a>{% endblock %}

{% block content %}
{% set qa = prop.quality_analysis %}
<article>
    {# Hero Gallery — visual anchor, full-bleed #}
    {% if prop.gallery_images %}
    {% set gallery = prop.gallery_images %}
    {% set hero_count = [gallery|length, 5] | min %}
    <div class="hero-gallery">
        <div class="hero-main">
            <img src="{{ image_url_map.get(gallery[0].url|string, gallery[0].url) }}" alt="{{ prop.title }}" loading="eager" data-lightbox>
        </div>
        {% if gallery|length > 1 %}
        <div class="hero-thumbs">
            {% for img in gallery[1:hero_count] %}
            <div class="hero-thumb">
                <img src="{{ image_url_map.get(img.url|string, img.url) }}" alt="Property photo {{ loop.index + 1 }}" loading="eager" data-lightbox>
                {% if loop.last and gallery|length > hero_count %}
                <div class="hero-more-overlay" data-gallery-more="{{ hero_count }}">+{{ gallery|length - hero_count }} more</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="hero-photo-count">{{ gallery|length }} photos</div>
    </div>
    {# Hidden images for lightbox navigation #}
    {% for img in gallery[hero_count:] %}
    <img src="{{ image_url_map.get(img.url|string, img.url) }}" alt="Property photo {{ hero_count + loop.index }}" data-lightbox hidden>
    {% endfor %}
    {% endif %}

    {# Header — Price is dominant (largest element), title secondary, meta tertiary #}
    <div class="detail-header">
        <div class="detail-header-row">
            <h1>{{ prop.title }}</h1>
            <p class="key-price">
                {% if prop.min_price and prop.max_price and prop.min_price != prop.max_price %}
                &pound;{{ "{:,}".format(prop.min_price) }}&ndash;{{ "{:,}".format(prop.max_price) }}
                {% else %}
                &pound;{{ "{:,}".format(prop.price_pcm) }}
                {% endif %}
                <span class="key-price-label">/mo</span>
            </p>
        </div>
        <div class="detail-header-row">
            <p class="detail-meta">
                {{ prop.bedrooms }} bed &middot; {{ prop.address }}{% if prop.postcode %}, {{ prop.postcode }}{% endif %}
                {%- for source_key in prop.sources_list -%}
                {%- set url = prop.source_urls_dict.get(source_key) -%}
                {%- if url %}
                <span class="meta-sep">&middot;</span>
                <a href="{{ url }}" target="_blank" rel="noopener" class="meta-link">{{ source_names.get(source_key, source_key) }}&nbsp;&#8599;</a>
                {%- endif -%}
                {%- endfor -%}
                {%- if prop.latitude and prop.longitude %}
                <span class="meta-sep">&middot;</span>
                <a href="https://www.google.com/maps?q={{ prop.latitude }},{{ prop.longitude }}" target="_blank" rel="noopener" class="meta-link meta-link-dim">Map&nbsp;&#8599;</a>
                {%- endif %}
            </p>
            <div class="detail-header-meta">
                {% if prop.quality_rating %}
                <span class="star-rating">
                    {% for i in range(1, 6) %}
                        {% if i <= prop.quality_rating %}
                            <span class="star filled">&#9733;</span>
                        {% else %}
                            <span class="star empty">&#9734;</span>
                        {% endif %}
                    {% endfor %}
                </span>
                {% endif %}
                {{ commute_pill(prop.commute_minutes, prop.transport_mode) }}
            </div>
        </div>
    </div>

    {# Section Navigation — sticky anchor bar #}
    <nav class="section-nav" id="section-nav">
        <ul class="section-nav-links">
            {% if qa %}<li><a href="#section-overview">Overview</a></li>{% endif %}
            {% if qa %}<li><a href="#section-quality">Quality</a></li>{% endif %}
            {% if qa and qa.viewing_notes and (qa.viewing_notes.check_items or qa.viewing_notes.questions_for_agent or qa.viewing_notes.deal_breaker_tests) %}<li><a href="#section-viewing">Viewing Prep</a></li>{% endif %}
            {% if prop.floorplan_images %}<li><a href="#section-floorplan">Floorplan</a></li>{% endif %}
            {% if best_description %}<li><a href="#section-description">Description</a></li>{% endif %}
            {% if prop.latitude and prop.longitude %}<li><a href="#section-location">Location</a></li>{% endif %}
            {% if area_context and area_context.description %}<li><a href="#section-area">Area</a></li>{% endif %}
            <li class="section-nav-top"><a href="#top">Top</a></li>
        </ul>
    </nav>

    {# 1. Overview — the "executive summary" #}
    {% if qa %}
    <section id="section-overview" class="detail-section">
        <h3>Overview</h3>

        {% if qa.one_line %}
        <p class="overview-tagline">{{ qa.one_line.one_line if qa.one_line is mapping else qa.one_line }}</p>
        {% endif %}

        <blockquote>{{ qa.summary }}</blockquote>

        {% if qa.highlights or qa.lowlights %}
        <div class="overview-chips">
            {% if qa.highlights %}
            {% for tag in qa.highlights %}
            {% if not (qa.listing_extraction and qa.listing_extraction.epc_rating and qa.listing_extraction.epc_rating != 'unknown' and tag[:3] | upper == "EPC") %}
            <span class="highlight-chip highlight-positive">{{ tag }}</span>
            {% endif %}
            {% endfor %}
            {% endif %}
            {% if qa.lowlights %}
            {% for tag in qa.lowlights %}
            <span class="highlight-chip highlight-negative">{{ tag }}</span>
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}

        {% if qa.value %}
        <div class="overview-card value-assessment-card">
            <h4>Value Assessment</h4>
            {% if qa.value.rating %}
            <div class="value-row">
                <span class="value-row-label">Market value</span>
                <span class="badge
                    {% if qa.value.rating in ('excellent', 'good') %}badge-green
                    {% elif qa.value.rating == 'fair' %}badge-amber
                    {% else %}badge-red{% endif %}">
                    {{ qa.value.rating | capitalize }}
                </span>
                {% if qa.value.note %}<span class="value-row-note">{{ qa.value.note }}</span>{% endif %}
            </div>
            {% endif %}
            {% if qa.value.quality_adjusted_rating %}
            <div class="value-row">
                <span class="value-row-label">Quality-adjusted</span>
                <span class="badge
                    {% if qa.value.quality_adjusted_rating in ('excellent', 'good') %}badge-green
                    {% elif qa.value.quality_adjusted_rating == 'fair' %}badge-amber
                    {% else %}badge-red{% endif %}">
                    {{ qa.value.quality_adjusted_rating | capitalize }}
                </span>
            </div>
            {% if qa.value.quality_adjusted_note %}
            <p class="value-detail-note">{{ qa.value.quality_adjusted_note }}</p>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}

        {# Listing Details — compact KV grid (moved from quality card) #}
        {% if qa.listing_extraction %}
        {% set le = qa.listing_extraction %}
        {% set has_listing_data = (le.epc_rating and le.epc_rating != 'unknown') or le.service_charge_pcm or le.deposit_weeks is not none or le.bills_included != 'unknown' or le.pets_allowed != 'unknown' or (le.parking and le.parking != 'unknown') or (le.council_tax_band and le.council_tax_band != 'unknown') or (le.property_type and le.property_type != 'unknown') or (le.furnished_status and le.furnished_status != 'unknown') or (le.broadband_type and le.broadband_type != 'unknown') %}
        {% if has_listing_data %}
        <div class="listing-details-section">
            <h4 class="section-subhead">Listing Details</h4>
            <div class="listing-kv-grid">
                {% if le.property_type and le.property_type != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Type</span><span class="listing-kv-value">{{ le.property_type | replace("_", " ") | title }}</span></div>
                {% endif %}
                {% if le.epc_rating and le.epc_rating != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">EPC</span><span class="listing-kv-value">Band {{ le.epc_rating }}</span></div>
                {% endif %}
                {% if le.service_charge_pcm %}
                <div class="listing-kv-item"><span class="listing-kv-label">Service Charge</span><span class="listing-kv-value">&pound;{{ le.service_charge_pcm }}/mo</span></div>
                {% endif %}
                {% if le.deposit_weeks is not none %}
                <div class="listing-kv-item"><span class="listing-kv-label">Deposit</span><span class="listing-kv-value">{{ le.deposit_weeks }} weeks</span></div>
                {% endif %}
                {% if le.bills_included == 'yes' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Bills</span><span class="listing-kv-value">Included</span></div>
                {% elif le.bills_included == 'no' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Bills</span><span class="listing-kv-value">Not included</span></div>
                {% endif %}
                {% if le.pets_allowed == 'yes' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Pets</span><span class="listing-kv-value">Allowed</span></div>
                {% elif le.pets_allowed == 'no' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Pets</span><span class="listing-kv-value">Not allowed</span></div>
                {% endif %}
                {% if le.parking and le.parking != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Parking</span><span class="listing-kv-value">{{ le.parking | capitalize }}</span></div>
                {% endif %}
                {% if le.council_tax_band and le.council_tax_band != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Council Tax</span><span class="listing-kv-value">Band {{ le.council_tax_band }}</span></div>
                {% endif %}
                {% if le.furnished_status and le.furnished_status != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Furnished</span><span class="listing-kv-value">{{ le.furnished_status | replace("_", " ") | capitalize }}</span></div>
                {% endif %}
                {% if le.broadband_type and le.broadband_type != 'unknown' %}
                <div class="listing-kv-item"><span class="listing-kv-label">Broadband</span><span class="listing-kv-value">{{ le.broadband_type | upper }}</span></div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        {% if cost_breakdown or (fit_score is not none and fit_breakdown) %}
        <div class="overview-pair">
        {% if cost_breakdown %}
        <div class="overview-card cost-breakdown-card">
            <div class="cost-header">
                <h4>True Monthly Cost</h4>
                {% if cost_breakdown.extras > 0 %}
                <span class="cost-extras-badge">+&pound;{{ "{:,}".format(cost_breakdown.extras) }}{% if cost_breakdown.extras_high %}&ndash;{{ "{:,}".format(cost_breakdown.extras_high) }}{% endif %} beyond rent</span>
                {% endif %}
            </div>
            <div class="cost-receipt">
                {% for item in cost_breakdown.line_items %}
                {% if item.label != 'Bills' %}
                <div class="cost-line{% if item.label == 'Rent' %} cost-line-rent{% endif %}">
                    <span class="cost-line-label">{{ item.label }}{% if item.note %} <span class="cost-line-note">{{ item.note }}</span>{% endif %}</span>
                    <span class="cost-line-amount">
                        {% if item.amount is not none %}&pound;{{ "{:,}".format(item.amount) }}{% elif item.range_low is defined %}&pound;{{ item.range_low }}&ndash;{{ item.range_high }}{% endif %}
                    </span>
                </div>
                {% else %}
                <div class="cost-line cost-line-bills">
                    <span class="cost-line-label">Bills <span class="cost-line-note">included in rent</span></span>
                    <span class="cost-line-amount">&pound;0</span>
                </div>
                {% endif %}
                {% endfor %}
                <div class="cost-line cost-line-total">
                    <span class="cost-line-label">Total</span>
                    <span class="cost-line-amount">&pound;{{ "{:,}".format(cost_breakdown.total) }}{% if cost_breakdown.total_high %}<span class="cost-line-range">&ndash;{{ "{:,}".format(cost_breakdown.total_high) }}</span>{% endif %}<span class="cost-line-per">/mo</span></span>
                </div>
            </div>
        </div>
        {% endif %}

        {% if fit_score is not none and fit_breakdown %}
        <div class="overview-card fit-breakdown-card">
            <h4>
                Marcel Fit
                <span class="fit-breakdown-donut-wrap">
                    <span class="fit-breakdown-donut {% if fit_score >= 80 %}fit-green{% elif fit_score >= 60 %}fit-accent{% elif fit_score >= 40 %}fit-amber{% else %}fit-dim{% endif %}" style="--score-pct: {{ fit_score }}"></span>
                    <span class="fit-breakdown-donut-value">{{ fit_score }}</span>
                </span>
                <span class="fit-breakdown-tier {{ fit_tier_class(fit_score) }}">{{ fit_tier_label(fit_score) }}</span>
            </h4>
            <div class="fit-breakdown-bars">
                {% for dim in fit_breakdown %}
                <div class="fit-breakdown-row{% if dim.confidence is defined and dim.confidence < 0.5 %} fit-dim-low-conf{% endif %}">
                    <span class="fit-breakdown-label">{{ dim.label }}</span>
                    <div class="fit-breakdown-track"><div class="fit-breakdown-fill {% if dim.score >= 70 %}fit-dim-green{% elif dim.score >= 40 %}fit-dim-accent{% else %}fit-dim-low{% endif %}" style="--bar-pct: {{ dim.score }}%"></div></div>
                    <span class="fit-breakdown-value">{{ dim.score }}</span>
                    <span class="fit-breakdown-weight">{{ dim.weight }}%</span>
                    {% if dim.confidence is defined and dim.confidence < 0.5 %}<span class="fit-dim-conf-hint" title="Limited data for this dimension">?</span>{% endif %}
                </div>
                {% endfor %}
            </div>
            <p class="fit-breakdown-legend">Score 0-100 per dimension, weighted by importance to Marcel's WFH + hosting lifestyle.</p>
        </div>
        {% endif %}
        </div>
        {% endif %}

        {% if qa.condition_concerns %}
        <div class="quality-alert
            {% if qa.concern_severity == 'serious' %}alert-red
            {% elif qa.concern_severity == 'moderate' %}alert-amber
            {% else %}alert-green{% endif %}">
            <strong>Condition Concerns ({{ qa.concern_severity or "unknown" }}):</strong>
            <p>{{ qa.condition.maintenance_concerns | join(", ") }}</p>
        </div>
        {% endif %}

        {% if qa.listing_red_flags and qa.listing_red_flags.red_flag_count > 0 %}
        <div class="quality-alert alert-amber">
            <strong>Listing Red Flags ({{ qa.listing_red_flags.red_flag_count }}):</strong>
            {% if qa.listing_red_flags.too_few_photos %}<p>Too few photos</p>{% endif %}
            {% if qa.listing_red_flags.selective_angles %}<p>Selective camera angles</p>{% endif %}
            {% if qa.listing_red_flags.missing_room_photos %}
            <p>No photos of: {{ qa.listing_red_flags.missing_room_photos | join(", ") }}</p>
            {% endif %}
            {% if qa.listing_red_flags.description_concerns %}
            {% for concern in qa.listing_red_flags.description_concerns %}
            <p>{{ concern }}</p>
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    {# 2. Quality Analysis — room-by-room breakdown #}
    {% include "_quality_card.html" %}

    {# 2b. Viewing Prep — actionable checklist promoted to top-level section #}
    {% if qa and qa.viewing_notes %}
    {% set vn = qa.viewing_notes %}
    {% if vn.check_items or vn.questions_for_agent or vn.deal_breaker_tests %}
    <section id="section-viewing" class="detail-section">
        <h3>Viewing Prep</h3>
        {% if vn.check_items %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Things to Check</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for item in vn.check_items %}
                    <li>{{ item }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% if vn.questions_for_agent %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Ask the Agent</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for q in vn.questions_for_agent %}
                    <li>{{ q }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% if vn.deal_breaker_tests %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Quick Tests</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for t in vn.deal_breaker_tests %}
                    <li>{{ t }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </section>
    {% endif %}
    {% endif %}

    {# 3. Floorplan — spatial understanding #}
    {% if prop.floorplan_images %}
    <section id="section-floorplan" class="detail-section">
        <h3>Floorplan</h3>
        <div class="floorplan-section">
            {% for img in prop.floorplan_images %}
            <div class="floorplan-frame">
                <img src="{{ image_url_map.get(img.url|string, img.url) }}" alt="Floorplan" loading="lazy" class="floorplan-image" data-lightbox>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# 4. Description — agent copy, lower priority #}
    {% if best_description %}
    <section id="section-description" class="detail-section">
        <h3>Description</h3>
        <div class="description-container">
            <div class="description-text" id="description-text">{{ best_description | e | replace("\n", "<br>") | safe }}</div>
            <button class="description-toggle" id="description-toggle" hidden>Read more</button>
        </div>
    </section>
    {% endif %}

    {# 5. Location Map #}
    {% if prop.latitude and prop.longitude %}
    <section id="section-location" class="detail-section">
        <h3>Location</h3>
        <div id="map" data-lat="{{ prop.latitude }}" data-lon="{{ prop.longitude }}" data-title="{{ prop.address }}" role="application" aria-label="Map showing property location at {{ prop.address }}"></div>
    </section>
    {% endif %}

    {# 6. Area Context — compact summary card (full details on /area/{outcode}) #}
    {% if area_context and area_context.description %}
    <section id="section-area" class="detail-section">
        <h3>Area: {{ outcode }}</h3>
        <div class="area-summary-card">
            {% if area_context.matched_micro_area %}
            {% set ma_name = area_context.matched_micro_area.name %}
            {% set ma = area_context.matched_micro_area.data %}
            <div class="area-summary-header">
                <strong>{{ ma_name }}</strong>
                <span class="area-summary-badges">
                    {% if ma.hosting_tolerance %}
                    <span class="badge {% if ma.hosting_tolerance == 'high' %}badge-green{% elif ma.hosting_tolerance == 'moderate' %}badge-amber{% else %}badge-red{% endif %}">Hosting: {{ ma.hosting_tolerance }}</span>
                    {% endif %}
                    {% if ma.wfh_suitability %}
                    <span class="badge {% if ma.wfh_suitability == 'good' %}badge-green{% elif ma.wfh_suitability == 'moderate' %}badge-amber{% else %}badge-red{% endif %}">WFH: {{ ma.wfh_suitability }}</span>
                    {% endif %}
                </span>
            </div>
            {% if ma.character %}<p class="area-summary-character">{{ ma.character }}</p>{% endif %}
            {% endif %}

            <div class="area-summary-stats">
                {% if area_context.crime %}
                <div class="area-summary-stat">
                    <span class="area-summary-stat-label">Crime</span>
                    <span class="badge
                        {% if area_context.crime.risk in ('low', 'low-medium') %}badge-green
                        {% elif area_context.crime.risk == 'medium' %}badge-amber
                        {% else %}badge-red{% endif %}">{{ area_context.crime.risk }}</span>
                    <span class="area-summary-stat-detail">{{ area_context.crime.rate }}/1k residents</span>
                </div>
                {% endif %}

                {% if area_context.benchmarks and prop.bedrooms in area_context.benchmarks %}
                <div class="area-summary-stat">
                    <span class="area-summary-stat-label">{{ prop.bedrooms }}-bed avg</span>
                    <span class="area-summary-stat-detail">&pound;{{ "{:,}".format(area_context.benchmarks[prop.bedrooms]) }}/mo</span>
                </div>
                {% endif %}

                {% if area_context.acoustic_profile %}
                <div class="area-summary-stat">
                    <span class="area-summary-stat-label">Sound</span>
                    <span class="badge
                        {% if area_context.acoustic_profile.hosting_safety == 'good' %}badge-green
                        {% elif area_context.acoustic_profile.hosting_safety == 'moderate' %}badge-amber
                        {% else %}badge-red{% endif %}">{{ area_context.acoustic_profile.hosting_safety }}</span>
                </div>
                {% endif %}
            </div>

            <a href="/area/{{ outcode }}{% if area_context.matched_micro_area %}?highlight={{ area_context.matched_micro_area.name | urlencode }}{% endif %}" class="area-summary-link">Full area guide &rarr;</a>
        </div>
    </section>
    {% endif %}
</article>

{# Lightbox overlay #}
<div id="lightbox" class="lightbox" hidden>
    <button class="lightbox-close" aria-label="Close">&times;</button>
    <button class="lightbox-prev" aria-label="Previous">&lsaquo;</button>
    <img class="lightbox-img" src="" alt="Full size">
    <button class="lightbox-next" aria-label="Next">&rsaquo;</button>
    <div class="lightbox-counter"></div>
</div>
{% endblock %}
