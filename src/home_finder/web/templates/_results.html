{% macro page_url(target_page) %}?page={{ target_page }}&sort={{ sort }}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if bedrooms is not none %}&bedrooms={{ bedrooms }}{% endif %}{% if min_rating %}&min_rating={{ min_rating }}{% endif %}{% if area %}&area={{ area }}{% endif %}{% if property_type %}&property_type={{ property_type }}{% endif %}{% if outdoor_space %}&outdoor_space={{ outdoor_space }}{% endif %}{% if natural_light %}&natural_light={{ natural_light }}{% endif %}{% if pets %}&pets={{ pets }}{% endif %}{% if value_rating %}&value_rating={{ value_rating }}{% endif %}{% if hob_type %}&hob_type={{ hob_type }}{% endif %}{% if floor_level %}&floor_level={{ floor_level }}{% endif %}{% if building_construction %}&building_construction={{ building_construction }}{% endif %}{% if office_separation %}&office_separation={{ office_separation }}{% endif %}{% if hosting_layout %}&hosting_layout={{ hosting_layout }}{% endif %}{% if hosting_noise_risk %}&hosting_noise_risk={{ hosting_noise_risk }}{% endif %}{% if broadband_type %}&broadband_type={{ broadband_type }}{% endif %}{% if tags %}{% for t in tags %}&tag={{ t | urlencode }}{% endfor %}{% endif %}{% endmacro %}

<span id="nav-count" hx-swap-oob="innerHTML:#nav-count">{{ total }} properties{% if active_filters %} <small>({{ active_filters|length }} filter{{ 's' if active_filters|length != 1 }} active)</small>{% endif %}</span>

<div class="sr-only" aria-live="polite">{{ total }} propert{{ "y" if total == 1 else "ies" }} found</div>

{% if active_filters %}
<div class="filter-chips-row">
    {% for f in active_filters %}
    <span class="filter-chip">
        {{ f.label }}
        <button type="button" class="filter-chip-remove" data-filter-key="{{ f.key }}"{% if f.value %} data-filter-value="{{ f.value }}"{% endif %} aria-label="Remove {{ f.label }} filter">&times;</button>
    </span>
    {% endfor %}
</div>
{% endif %}

{% if properties %}
<div class="card-grid">
    {% for prop in properties %}
        <div class="card-entrance" style="--card-index: {{ loop.index0 }}">
        {% include "_property_card.html" %}
        </div>
    {% endfor %}
</div>

{% if total_pages > 1 %}
<nav class="pagination">
    {% if page > 1 %}
    {% set prev_url = page_url(page - 1) %}
    <a href="{{ prev_url }}" hx-get="{{ prev_url }}"
       hx-target="#results" hx-push-url="true" hx-indicator="#loading"
       role="button" class="outline">Previous</a>
    {% endif %}
    <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>
    {% if page < total_pages %}
    {% set next_url = page_url(page + 1) %}
    <a href="{{ next_url }}" hx-get="{{ next_url }}"
       hx-target="#results" hx-push-url="true" hx-indicator="#loading"
       role="button" class="outline">Next</a>
    {% endif %}
</nav>
{% endif %}

{% else %}
<div class="empty-state">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
    </svg>
    <h3>No properties found</h3>
    <p>Try adjusting your filters or broadening your search criteria.</p>
    <a href="/" role="button" class="outline"
       hx-get="/" hx-target="#results" hx-push-url="true" hx-indicator="#loading">Reset filters</a>
</div>
{% endif %}

<script>
if (typeof window._updateMapData === "function") {
    window._updateMapData({{ properties_json | safe }});
}
</script>
