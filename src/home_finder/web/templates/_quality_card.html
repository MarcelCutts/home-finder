{% from "_macros.html" import quality_badge, quality_item_class %}
{% if qa %}
<section id="section-quality" class="detail-section quality-section">
    <h3>Quality Analysis
        {% if qa.overall_rating %}
        <span class="star-rating">
            {% for i in range(1, 6) %}
                {% if i <= qa.overall_rating %}<span class="star filled">&#9733;</span>{% else %}<span class="star empty">&#9734;</span>{% endif %}
            {% endfor %}
        </span>
        {% endif %}
    </h3>

    {# Room-by-room grid #}
    <div class="quality-grid">
        <div class="{{ quality_item_class(qa.kitchen.overall_quality, ['modern'], ['decent'], ['dated']) }}">
            <h4>Kitchen</h4>
            {% call quality_badge(qa.kitchen.overall_quality, ['modern'], ['decent'], ['dated']) %}{{ qa.kitchen.overall_quality | capitalize }}{% endcall %}
            {% if qa.kitchen.hob_type and qa.kitchen.hob_type != 'unknown' %}
            <p>{{ qa.kitchen.hob_type | capitalize }} hob</p>
            {% endif %}
            {% set appliances = [] %}
            {% if qa.kitchen.has_dishwasher == 'yes' %}{% set _ = appliances.append("Dishwasher") %}{% endif %}
            {% if qa.kitchen.has_washing_machine == 'yes' %}{% set _ = appliances.append("Washing machine") %}{% endif %}
            {% if appliances %}
            <p>{{ appliances | join(" Â· ") }}</p>
            {% endif %}
            {% if qa.kitchen.notes %}<p><small>{{ qa.kitchen.notes }}</small></p>{% endif %}
        </div>

        {% if qa.bathroom %}
        <div class="{{ quality_item_class(qa.bathroom.overall_condition, ['modern'], ['decent'], ['dated']) }}">
            <h4>Bathroom</h4>
            {% call quality_badge(qa.bathroom.overall_condition, ['modern'], ['decent'], ['dated']) %}{{ qa.bathroom.overall_condition | capitalize }}{% endcall %}
            {% if qa.bathroom.has_bathtub == 'yes' %}
            <p>Bathtub</p>
            {% elif qa.bathroom.has_bathtub == 'no' %}
            <p>No bathtub</p>
            {% endif %}
            {% if qa.bathroom.shower_type and qa.bathroom.shower_type not in ('unknown', 'none') %}
            <p>{{ qa.bathroom.shower_type | replace("_", " ") | capitalize }} shower</p>
            {% endif %}
            {% if qa.bathroom.is_ensuite == 'yes' %}<p>Ensuite</p>{% endif %}
            {% if qa.bathroom.notes %}<p><small>{{ qa.bathroom.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        <div class="{{ quality_item_class(qa.condition.overall_condition, ['excellent', 'good'], ['fair'], ['poor']) }}">
            <h4>Condition</h4>
            {% call quality_badge(qa.condition.overall_condition, ['excellent', 'good'], ['fair'], ['poor']) %}{{ qa.condition.overall_condition | capitalize }}{% endcall %}
            {% if qa.condition.has_visible_damp == 'yes' %}<p>Visible damp</p>{% endif %}
            {% if qa.condition.has_visible_mold == 'yes' %}<p>Visible mould</p>{% endif %}
            {% if qa.condition.has_worn_fixtures == 'yes' %}<p>Worn fixtures</p>{% endif %}
            {% if qa.condition.maintenance_concerns %}
            <p><small>{{ qa.condition.maintenance_concerns | join(", ") }}</small></p>
            {% elif qa.condition.overall_condition in ('excellent', 'good') and qa.condition.has_visible_damp != 'yes' and qa.condition.has_visible_mold != 'yes' and qa.condition.has_worn_fixtures != 'yes' %}
            <p><small>No concerns found</small></p>
            {% endif %}
        </div>

        <div class="{{ quality_item_class(qa.light_space.natural_light, ['excellent', 'good'], ['fair'], ['poor']) }}">
            <h4>Light &amp; Space</h4>
            {% call quality_badge(qa.light_space.natural_light, ['excellent', 'good'], ['fair'], ['poor']) %}Light: {{ qa.light_space.natural_light | capitalize }}{% endcall %}
            {% if qa.light_space.feels_spacious is not none %}
            <p>{{ "Spacious" if qa.light_space.feels_spacious else "Compact" }}</p>
            {% endif %}
            {% if qa.light_space.ceiling_height and qa.light_space.ceiling_height != 'unknown' %}
            <p>Ceilings: {{ qa.light_space.ceiling_height }}</p>
            {% endif %}
            {% if qa.light_space.notes %}<p><small>{{ qa.light_space.notes }}</small></p>{% endif %}
        </div>

        <div class="{{ quality_item_class(qa.space.hosting_layout, ['excellent', 'good'], ['awkward'], ['poor']) }}">
            <h4>Living Room</h4>
            {% if qa.space.living_room_sqm %}
            <span class="badge badge-neutral">~{{ "%.0f" | format(qa.space.living_room_sqm) }}m&sup2;</span>
            {% else %}
            <span class="badge badge-neutral">Size unknown</span>
            {% endif %}
            {% if qa.space.is_spacious_enough is not none %}
            <p>{{ "Good for office + hosting" if qa.space.is_spacious_enough else "May be tight" }}</p>
            {% endif %}
            {% if qa.space.hosting_layout and qa.space.hosting_layout != 'unknown' %}
            {% call quality_badge(qa.space.hosting_layout, ['excellent', 'good'], ['awkward'], ['poor']) %}Layout: {{ qa.space.hosting_layout | capitalize }}{% endcall %}
            {% endif %}
        </div>

        {% if qa.bedroom %}
        <div class="{{ quality_item_class(qa.bedroom.office_separation, ['dedicated_room', 'separate_area'], ['shared_space'], ['none']) }}">
            <h4>Bedroom</h4>
            {% if qa.bedroom.primary_is_double != 'unknown' %}
            <p>{{ "Double bed fits" if qa.bedroom.primary_is_double == 'yes' else "Single only" }}</p>
            {% endif %}
            {% if qa.bedroom.has_built_in_wardrobe == 'yes' %}<p>Built-in wardrobe</p>{% elif qa.bedroom.has_built_in_wardrobe == 'no' %}<p>No built-in wardrobe</p>{% endif %}
            {% if qa.bedroom.can_fit_desk != 'unknown' %}
            <p>{{ "Desk fits" if qa.bedroom.can_fit_desk == 'yes' else "No desk space" }}</p>
            {% endif %}
            {% if qa.bedroom.office_separation and qa.bedroom.office_separation != 'unknown' %}
            <p>Office: {{ qa.bedroom.office_separation | replace("_", " ") | capitalize }}</p>
            {% endif %}
            {% if qa.bedroom.notes %}<p><small>{{ qa.bedroom.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        {% if qa.outdoor_space %}
        {% set outdoor_items = [] %}
        {% if qa.outdoor_space.has_balcony %}{% set _ = outdoor_items.append("Balcony") %}{% endif %}
        {% if qa.outdoor_space.has_garden %}{% set _ = outdoor_items.append("Garden") %}{% endif %}
        {% if qa.outdoor_space.has_terrace %}{% set _ = outdoor_items.append("Terrace") %}{% endif %}
        {% if qa.outdoor_space.has_shared_garden %}{% set _ = outdoor_items.append("Shared garden") %}{% endif %}
        <div class="quality-item {% if outdoor_items %}quality-item-excellent{% else %}quality-item-poor{% endif %}">
            <h4>Outdoor Space</h4>
            {% if outdoor_items %}
            <span class="badge badge-green">{{ outdoor_items | join(", ") }}</span>
            {% else %}
            <span class="badge badge-neutral">None</span>
            {% endif %}
            {% if qa.outdoor_space.notes %}<p><small>{{ qa.outdoor_space.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        {% if qa.storage %}
        <div class="{{ quality_item_class(qa.storage.storage_rating, ['good'], ['adequate'], ['poor']) }}">
            <h4>Storage</h4>
            {% call quality_badge(qa.storage.storage_rating, ['good'], ['adequate'], ['poor']) %}{{ qa.storage.storage_rating | capitalize }}{% endcall %}
            {% if qa.storage.has_built_in_wardrobes == 'yes' %}<p>Built-in wardrobes</p>{% elif qa.storage.has_built_in_wardrobes == 'no' %}<p>No built-in wardrobes</p>{% endif %}
            {% if qa.storage.has_hallway_cupboard == 'yes' %}<p>Hallway cupboard</p>{% elif qa.storage.has_hallway_cupboard == 'no' %}<p>No hallway cupboard</p>{% endif %}
        </div>
        {% endif %}

        {% if qa.flooring_noise %}
        <div class="{{ quality_item_class(qa.flooring_noise.hosting_noise_risk, ['low'], ['moderate'], ['high']) }}">
            <h4>Flooring &amp; Noise</h4>
            {% if qa.flooring_noise.hosting_noise_risk and qa.flooring_noise.hosting_noise_risk != 'unknown' %}
            {% call quality_badge(qa.flooring_noise.hosting_noise_risk, ['low'], ['moderate'], ['high']) %}{{ qa.flooring_noise.hosting_noise_risk | capitalize }}{% endcall %}
            {% endif %}
            {% if qa.flooring_noise.primary_flooring != 'unknown' %}
            <p>{{ qa.flooring_noise.primary_flooring | capitalize }}</p>
            {% endif %}
            {% if qa.flooring_noise.has_double_glazing == 'yes' %}
            <p>Double glazed</p>
            {% elif qa.flooring_noise.has_double_glazing == 'no' %}
            <p>Single glazing</p>
            {% endif %}
            {% if qa.flooring_noise.noise_indicators %}
            <p><small>{{ qa.flooring_noise.noise_indicators | join(", ") }}</small></p>
            {% endif %}
            {% if qa.flooring_noise.notes %}<p><small>{{ qa.flooring_noise.notes }}</small></p>{% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endif %}
