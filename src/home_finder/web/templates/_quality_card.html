{% from "_macros.html" import quality_badge, quality_item_class %}
{% if qa %}
<section id="section-quality" class="detail-section quality-section">
    <h3>Quality Analysis
        {% if qa.overall_rating %}
        <span class="star-rating">
            {% for i in range(1, 6) %}
                {% if i <= qa.overall_rating %}<span class="star filled">&#9733;</span>{% else %}<span class="star empty">&#9734;</span>{% endif %}
            {% endfor %}
        </span>
        {% endif %}
    </h3>

    {# Room-by-room grid #}
    <div class="quality-grid">
        <div class="{{ quality_item_class(qa.kitchen.overall_quality, ['modern'], ['decent'], ['dated']) }}">
            <h4>Kitchen</h4>
            {% call quality_badge(qa.kitchen.overall_quality, ['modern'], ['decent'], ['dated']) %}{{ qa.kitchen.overall_quality | capitalize }}{% endcall %}
            {% if qa.kitchen.hob_type and qa.kitchen.hob_type != 'unknown' %}
            <p>{{ qa.kitchen.hob_type | capitalize }} hob</p>
            {% endif %}
            {% set appliances = [] %}
            {% if qa.kitchen.has_dishwasher == 'yes' %}{% set _ = appliances.append("Dishwasher") %}{% endif %}
            {% if qa.kitchen.has_washing_machine == 'yes' %}{% set _ = appliances.append("Washing machine") %}{% endif %}
            {% if appliances %}
            <p>{{ appliances | join(" · ") }}</p>
            {% endif %}
            {% if qa.kitchen.notes %}<p><small>{{ qa.kitchen.notes }}</small></p>{% endif %}
        </div>

        {% if qa.bathroom %}
        <div class="{{ quality_item_class(qa.bathroom.overall_condition, ['modern'], ['decent'], ['dated']) }}">
            <h4>Bathroom</h4>
            {% call quality_badge(qa.bathroom.overall_condition, ['modern'], ['decent'], ['dated']) %}{{ qa.bathroom.overall_condition | capitalize }}{% endcall %}
            {% if qa.bathroom.has_bathtub == 'yes' %}
            <p>Bathtub</p>
            {% elif qa.bathroom.has_bathtub == 'no' %}
            <p>No bathtub</p>
            {% endif %}
            {% if qa.bathroom.shower_type and qa.bathroom.shower_type not in ('unknown', 'none') %}
            <p>{{ qa.bathroom.shower_type | replace("_", " ") | capitalize }} shower</p>
            {% endif %}
            {% if qa.bathroom.is_ensuite == 'yes' %}<p>Ensuite</p>{% endif %}
            {% if qa.bathroom.notes %}<p><small>{{ qa.bathroom.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        <div class="{{ quality_item_class(qa.condition.overall_condition, ['excellent', 'good'], ['fair'], ['poor']) }}">
            <h4>Condition</h4>
            {% call quality_badge(qa.condition.overall_condition, ['excellent', 'good'], ['fair'], ['poor']) %}{{ qa.condition.overall_condition | capitalize }}{% endcall %}
            {% if qa.condition.has_visible_damp == 'yes' %}<p>Visible damp</p>{% endif %}
            {% if qa.condition.has_visible_mold == 'yes' %}<p>Visible mould</p>{% endif %}
            {% if qa.condition.has_worn_fixtures == 'yes' %}<p>Worn fixtures</p>{% endif %}
            {% if qa.condition.maintenance_concerns %}
            <p><small>{{ qa.condition.maintenance_concerns | join(", ") }}</small></p>
            {% elif qa.condition.overall_condition in ('excellent', 'good') and qa.condition.has_visible_damp != 'yes' and qa.condition.has_visible_mold != 'yes' and qa.condition.has_worn_fixtures != 'yes' %}
            <p><small>No concerns found</small></p>
            {% endif %}
        </div>

        <div class="{{ quality_item_class(qa.light_space.natural_light, ['excellent', 'good'], ['fair'], ['poor']) }}">
            <h4>Light &amp; Space</h4>
            {% call quality_badge(qa.light_space.natural_light, ['excellent', 'good'], ['fair'], ['poor']) %}Light: {{ qa.light_space.natural_light | capitalize }}{% endcall %}
            {% if qa.light_space.feels_spacious is not none %}
            <p>{{ "Spacious" if qa.light_space.feels_spacious else "Compact" }}</p>
            {% endif %}
            {% if qa.light_space.ceiling_height and qa.light_space.ceiling_height != 'unknown' %}
            <p>Ceilings: {{ qa.light_space.ceiling_height }}</p>
            {% endif %}
            {% if qa.light_space.notes %}<p><small>{{ qa.light_space.notes }}</small></p>{% endif %}
        </div>

        <div class="quality-item quality-item-neutral">
            <h4>Living Room</h4>
            {% if qa.space.living_room_sqm %}
            <span class="badge badge-neutral">~{{ "%.0f" | format(qa.space.living_room_sqm) }}m&sup2;</span>
            {% else %}
            <span class="badge badge-neutral">Size unknown</span>
            {% endif %}
            {% if qa.space.is_spacious_enough is not none %}
            <p>{{ "Good for office + hosting" if qa.space.is_spacious_enough else "May be tight" }}</p>
            {% endif %}
        </div>

        {% if qa.bedroom %}
        <div class="quality-item quality-item-neutral">
            <h4>Bedroom</h4>
            {% if qa.bedroom.primary_is_double != 'unknown' %}
            <p>{{ "Double bed fits" if qa.bedroom.primary_is_double == 'yes' else "Single only" }}</p>
            {% endif %}
            {% if qa.bedroom.has_built_in_wardrobe == 'yes' %}<p>Built-in wardrobe</p>{% elif qa.bedroom.has_built_in_wardrobe == 'no' %}<p>No built-in wardrobe</p>{% endif %}
            {% if qa.bedroom.can_fit_desk != 'unknown' %}
            <p>{{ "Desk fits" if qa.bedroom.can_fit_desk == 'yes' else "No desk space" }}</p>
            {% endif %}
            {% if qa.bedroom.notes %}<p><small>{{ qa.bedroom.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        {% if qa.outdoor_space %}
        {% set outdoor_items = [] %}
        {% if qa.outdoor_space.has_balcony %}{% set _ = outdoor_items.append("Balcony") %}{% endif %}
        {% if qa.outdoor_space.has_garden %}{% set _ = outdoor_items.append("Garden") %}{% endif %}
        {% if qa.outdoor_space.has_terrace %}{% set _ = outdoor_items.append("Terrace") %}{% endif %}
        {% if qa.outdoor_space.has_shared_garden %}{% set _ = outdoor_items.append("Shared garden") %}{% endif %}
        <div class="quality-item {% if outdoor_items %}quality-item-excellent{% else %}quality-item-poor{% endif %}">
            <h4>Outdoor Space</h4>
            {% if outdoor_items %}
            <span class="badge badge-green">{{ outdoor_items | join(", ") }}</span>
            {% else %}
            <span class="badge badge-neutral">None</span>
            {% endif %}
            {% if qa.outdoor_space.notes %}<p><small>{{ qa.outdoor_space.notes }}</small></p>{% endif %}
        </div>
        {% endif %}

        {% if qa.storage %}
        <div class="{{ quality_item_class(qa.storage.storage_rating, ['good'], ['adequate'], ['poor']) }}">
            <h4>Storage</h4>
            {% call quality_badge(qa.storage.storage_rating, ['good'], ['adequate'], ['poor']) %}{{ qa.storage.storage_rating | capitalize }}{% endcall %}
            {% if qa.storage.has_built_in_wardrobes == 'yes' %}<p>Built-in wardrobes</p>{% elif qa.storage.has_built_in_wardrobes == 'no' %}<p>No built-in wardrobes</p>{% endif %}
            {% if qa.storage.has_hallway_cupboard == 'yes' %}<p>Hallway cupboard</p>{% elif qa.storage.has_hallway_cupboard == 'no' %}<p>No hallway cupboard</p>{% endif %}
        </div>
        {% endif %}

        {% if qa.flooring_noise %}
        <div class="quality-item quality-item-neutral">
            <h4>Flooring &amp; Noise</h4>
            {% if qa.flooring_noise.primary_flooring != 'unknown' %}
            <p>{{ qa.flooring_noise.primary_flooring | capitalize }}</p>
            {% endif %}
            {% if qa.flooring_noise.has_double_glazing == 'yes' %}
            <p>Double glazed</p>
            {% elif qa.flooring_noise.has_double_glazing == 'no' %}
            <p>Single glazing</p>
            {% endif %}
            {% if qa.flooring_noise.noise_indicators %}
            <p><small>{{ qa.flooring_noise.noise_indicators | join(", ") }}</small></p>
            {% endif %}
            {% if qa.flooring_noise.notes %}<p><small>{{ qa.flooring_noise.notes }}</small></p>{% endif %}
        </div>
        {% endif %}
    </div>

    {# Listing Details — lightweight key-value grid (visual hierarchy: secondary) #}
    {% if qa.listing_extraction %}
    {% set le = qa.listing_extraction %}
    {% set has_listing_data = (le.epc_rating and le.epc_rating != 'unknown') or le.service_charge_pcm or le.deposit_weeks is not none or le.bills_included != 'unknown' or le.pets_allowed != 'unknown' or (le.parking and le.parking != 'unknown') or (le.council_tax_band and le.council_tax_band != 'unknown') or (le.property_type and le.property_type != 'unknown') or (le.furnished_status and le.furnished_status != 'unknown') %}
    {% if has_listing_data %}
    <div class="listing-details-section">
        <h4 class="section-subhead">Listing Details</h4>
        <div class="listing-kv-grid">
            {% if le.property_type and le.property_type != 'unknown' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Type</span><span class="listing-kv-value">{{ le.property_type | replace("_", " ") | title }}</span></div>
            {% endif %}
            {% if le.epc_rating and le.epc_rating != 'unknown' %}
            <div class="listing-kv-item"><span class="listing-kv-label">EPC</span><span class="listing-kv-value">Band {{ le.epc_rating }}</span></div>
            {% endif %}
            {% if le.service_charge_pcm %}
            <div class="listing-kv-item"><span class="listing-kv-label">Service Charge</span><span class="listing-kv-value">&pound;{{ le.service_charge_pcm }}/mo</span></div>
            {% endif %}
            {% if le.deposit_weeks is not none %}
            <div class="listing-kv-item"><span class="listing-kv-label">Deposit</span><span class="listing-kv-value">{{ le.deposit_weeks }} weeks</span></div>
            {% endif %}
            {% if le.bills_included == 'yes' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Bills</span><span class="listing-kv-value">Included</span></div>
            {% elif le.bills_included == 'no' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Bills</span><span class="listing-kv-value">Not included</span></div>
            {% endif %}
            {% if le.pets_allowed == 'yes' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Pets</span><span class="listing-kv-value">Allowed</span></div>
            {% elif le.pets_allowed == 'no' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Pets</span><span class="listing-kv-value">Not allowed</span></div>
            {% endif %}
            {% if le.parking and le.parking != 'unknown' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Parking</span><span class="listing-kv-value">{{ le.parking | capitalize }}</span></div>
            {% endif %}
            {% if le.council_tax_band and le.council_tax_band != 'unknown' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Council Tax</span><span class="listing-kv-value">Band {{ le.council_tax_band }}</span></div>
            {% endif %}
            {% if le.furnished_status and le.furnished_status != 'unknown' %}
            <div class="listing-kv-item"><span class="listing-kv-label">Furnished</span><span class="listing-kv-value">{{ le.furnished_status | replace("_", " ") | capitalize }}</span></div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    {# Viewing Checklist — collapsible groups (progressive disclosure) #}
    {% if qa.viewing_notes %}
    {% set vn = qa.viewing_notes %}
    {% if vn.check_items or vn.questions_for_agent or vn.deal_breaker_tests %}
    <div class="listing-details-section">
        <h4 class="section-subhead">Viewing Checklist</h4>
        {% if vn.check_items %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Things to Check</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for item in vn.check_items %}
                    <li>{{ item }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% if vn.questions_for_agent %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Ask the Agent</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for q in vn.questions_for_agent %}
                    <li>{{ q }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        {% if vn.deal_breaker_tests %}
        <div class="viewing-checklist-group">
            <div class="viewing-group-header" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.viewing-group-toggle').classList.toggle('expanded')">
                <h4>Quick Tests</h4>
                <span class="viewing-group-toggle">&#9660;</span>
            </div>
            <div class="viewing-group-body open">
                <ul class="viewing-checklist">
                {% for t in vn.deal_breaker_tests %}
                    <li>{{ t }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endif %}
</section>
{% endif %}
